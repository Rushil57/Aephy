@{
    ViewData["Title"] = "- Describe solution";
}
<main id="main" class="main">
    <div class="row">
        <!-- Recent Sales -->
        <div class="col-12">
            <div class="card recent-sales overflow-auto">

                <div class="card-body">
                    <h5 class="card-title">Solutions</h5>

                    <table class="table table-borderless datatable" id="solutionList">
                        <thead>
                            <tr>
                                <th style="width:10%">Id</th>
                                <th style="width:10%">Title</th>
                              @*  <th style="width:10%">Sub Title</th>*@
                                <th style="width:30%">Description</th>
                                <th style="width:20%">Image</th>
                                <th style="width:10%">Services</th>
                                <th style="width:10%">Industries</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div><!-- End Recent Sales -->
    </div>
</main>

<div class="modal" id="EditsolutionModal" tabindex="-1" aria-labelledby="editSolutionModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Edit Solution</h4>
                <a class="close" onclick="ResetSolutionIndustryDetailForm();"><i class="bi bi-x-circle"></i></a>
            </div>
            <div class="modal-body p-0">
                <div class="row">
                    <div class="col">
                        <div class="card">
                            <div class="card-body">

                                <form class="row g-3 mt-3 cls-Solution" name="addSolutiondescribeForm">
                                    <input type="hidden" id="SolutionDetailsId" value="0">
                                    <input type="hidden" id="ImagePath" value="">

                                    <div class="col-12">
                                        <label for="SolutionTitle" class="form-label">Solution Title</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="SolutionTitle" name="SolutionTitle" readonly>
                                        </div>
                                    </div>
                                    <div class="col-12 cls-subtitle">
                                        <label for="Solution_SubTitle" class="form-label">Solution SubTitle</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="Solution_SubTitle" name="Solution_SubTitle" readonly>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <label for="Services" class="form-label">Services</label>
                                        <div class="input-group" id="services">
                                            <select data-placeholder="Choose tags ..." id="drp-services" name="SolutionServices" class="form-control" disabled>
                                                <option value="">Choose Services</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <label for="SolutionDescription" class="form-label">Solution Description</label>
                                        <div class="input-group">
                                            <textarea class="form-control" id="SolutionDescription" name="SolutionDescription" style="height:100px;" readonly></textarea>
                                        </div>
                                    </div>
                                    <div class="col-12" id="img-id">
                                        <label for="SolutionImage" class="form-label">Image</label>
                                        <div class="input-group">
                                            <input type="file" class="form-control" id="SolutionImage" name="SolutionImage" disabled />
                                        </div>
                                        <div id="solutionImagepreview"></div>
                                    </div>

                                    <div class="col-12">
                                        <label for="drp-assigned-freelancers" class="form-label">Assigned Freelancer</label>
                                        <div class="input-group" id="freelancer">
                                            <select data-placeholder="Choose tags ..." id="drp-assigned-freelancers" name="freelancer" class="form-control">
                                            </select>
                                        </div>
                                    </div>

                                    <div class="col-12" id="main-industry-div">
                                        <label for="Industries" class="form-label">Industries</label>
                                        <div class="input-group" id="industries">
                                            <select data-placeholder="Choose tags ..." name="Industries" multiple class="chosen-select" id="drp-industries">
                                            </select>
                                        </div>
                                    </div>
                                    <div class="text-center">
                                        <button type="submit" class="btn btn-brand">Submit</button>
                                        <button type="reset" class="btn btn-secondary" onclick="ResetSolutionIndustryDetailForm();">Reset</button>
                                    </div>
                                </form><!-- Vertical Form -->

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    $(function () {
        $("form[name='addSolutiondescribeForm']").validate({
            rules: {
                SolutionTitle: { required: true },

            },
            messages: {
                SolutionTitle: { required: "please select solution" },

            },
            submitHandler: function (form) {
                SaveDescribeSolutionData()
            }
        });
        GetSolutionList()
        $(".cls-subtitle").css("display","none")

    });

    function GetSolutionList() {
        $("#preloader").show();
        $.ajax({
            type: "Get",
            url: "@Url.Action("GetSolutionsIndustryDetailList", "Solutions")",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (result) {
                $("#preloader").hide();
                $('#solutionList').DataTable({
                    destroy: true,
                    data: result.Result,
                    "columns": [
                        {
                            "data": "Id",
                            "render": function (data, type, row) {
                                return '<a class="cls-service" onclick=GetSolutionDetailsDataById(' + data + ')>' + data + '</a>';
                            }
                        },
                        { "data": "Title" },
                        //{ "data": "SubTitle" },
                        {
                            "data": "Description",
                            "render": function (data, type, row) {
                                if (data != null) {
                                    var description = data.length > 35 ? data.substring(0, 35) + "..." : data;
                                    return "<span title='" + data + "'>" + description + "</span>";
                                }
                                else {
                                    return "<span></span>";
                                }

                            }
                        },
                        {
                            "data": "ImageUrlWithSas",
                            "render": function (data, type, row) {
                                if(data != null)
                                {
                                    return '<img src="' + data + '" alt="Image" height="70" width="150" />';
                                }
                                else{
                                    return "<span></span>";
                                }
                                
                            }
                        },
                        { "data": "Services" },
                        { "data": "Industries" }

                    ]
                });


            },
            error: function (result) {
                alert("failure");
            }
        });
    }


    function GetSolutionDetailsDataById(Id) {
        var ServiceData = {
            Id: Id,
        };
         $("#drp-assigned-freelancers").empty();
        GetFreelancerList();
        $.ajax({
            type: "POST",
            url: "@Url.Action("GetSolutionDetailsById", "Solutions")",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            data: JSON.stringify(ServiceData),
            success: function (result) {
                $("#EditsolutionModal").modal('show')
                $("#SolutionDetailsId").val(result.Result.SolutionIndustryDetails.Id)
                $("#SolutionTitle").val(result.Result.Solution.Title)
                $("#Solution_SubTitle").val(result.Result.Solution.SubTitle)
                $("#SolutionDescription").val(result.Result.Solution.Description)
                $("#drp-assigned-freelancers").val(result.Result.SolutionIndustryDetails.AssignedFreelancerId).trigger('chosen:updated');
                $("#drp-services").val(result.Result.Services.ServicesId)
                $('#drp-industries').val(result.Result.Industryname.Id).trigger('chosen:updated');
                 $('#drp-industries option').attr('disabled', true).trigger('chosen:updated');
                $("#solutionImagepreview").find("span").first().remove();
                $('#solutionImagepreview').show();
                var span = document.createElement('span');
                span.innerHTML =
                    ['<img class="SolutionImage" src="', result.Result.Solution.ImageUrlWithSas, '" style="height:200px;width:200px;"/>']
                        .join('');
                document.getElementById('solutionImagepreview').insertBefore(span, null);

                BindIndustriesControles(result.Result.Industryname, result.Result.SolutionIndustryDetails);
            },
            error: function (result) {
                alert("Error occured..");
            }
        });
    }

    function GetFreelancerList() {
        $.ajax({
            type: "Get",
            url: "@Url.Action("GetFreelancers", "Solutions")",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (result) {
                $.each(result.Result, function (data, value) {
                    $("#drp-assigned-freelancers").append($("<option     />").val(value.Id).text(value.FirstName + " " + value.LastName));
                });
                $('#drp-assigned-freelancers').trigger('chosen:updated');
            },
            error: function (err) {
                $("#preloader").hide();
                alert("Something Went Wrong!");
            }
        });
    }

    function GetAssignedFreelancerById(){
        $.ajax({
            type: "Get",
            url: "@Url.Action("GetFreelancers", "Solutions")",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (result) {
                $.each(result.Result, function (data, value) {
                    $("#drp-assigned-freelancers").append($("<option     />").val(value.Id).text(value.FirstName + " " + value.LastName));
                });
                $('#drp-assigned-freelancers').trigger('chosen:updated');
            },
            error: function (err) {
                $("#preloader").hide();
                alert("Something Went Wrong!");
            }
        });
    }

    function BindIndustriesControles(value,IndustryValue)
    {
        if (IndustryValue.Description == null)
        {
            IndustryValue.Description = "";
        }
        var addcontrols = "<div class='cls-industriesdiv'>" +
            "<div class='col-12'>" +
            "<label class='form-label'>Description (" + value.IndustryName + ") </label>" +
            "<div class='input-group'>" +
            //"<textarea type='text' class='form-control industrydescription' id=\"Description_" + value.IndustryName + "\" value=" + IndustryValue.Description + "></textarea>" +
            '<input type="text" class="form-control industrydescription"  value="' + IndustryValue.Description + '">' +
            "</div>" +
            "</div>" +
            "<div class='col-12'>" +
            "<label class='form-label'>Image (" + value.IndustryName + ")</label>" +
            "<div class='input-group'>" +
            "<input type='file' class='form-control industryImage' id=\"Image_" + value.IndustryName + "\" onchange='ChangeUploadImage(this)'>" +
            "</div>" +
            '<div id=solutionDetailsImagepreview_' + value.IndustryName + '>' +
            "</div>" +
            "</div>"
        $(addcontrols).insertAfter("#main-industry-div");

        if (IndustryValue.ImageUrlWithSas != null) {
            $("#solutionDetailsImagepreview_" + value.IndustryName).find("span").first().remove();
            $('#solutionDetailsImagepreview_' + value.IndustryName).show();
            var span = document.createElement('span');
            span.innerHTML =
                ['<img class="SolutionImage" src="', IndustryValue.ImageUrlWithSas, '" style="height:200px;width:200px;"/>']
                    .join('');
            document.getElementById('solutionDetailsImagepreview_' + value.IndustryName).insertBefore(span, null);
        }
    }

    function ChangeUploadImage(value) {
        var name = value.id.split("_")[1]
        if (value.files && value.files[0]) {
            var reader = new FileReader();
            reader.onload = (function (e) {
                $("#solutionDetailsImagepreview_" + name).find("span").first().remove();
                $('#solutionDetailsImagepreview_' + name).show();
                var span = document.createElement('span');
                span.innerHTML =
                    ['<img class="SolutionImage" src="', e.target.result, '" title="', escape(e.name), '" style="height:200px;width:200px;"/>']
                        .join('');
                document.getElementById('solutionDetailsImagepreview_' + name).insertBefore(span, null);
            });

            reader.readAsDataURL(value.files[0]);
        }
    }

     function SaveDescribeSolutionData() {
        var freelancerId = $("#drp-assigned-freelancers").val();
        var fileUpload = $(".industryImage").get(0);
        var files = fileUpload.files;
        var SolutionData = {
            Id: $("#SolutionDetailsId").val(),
            Description: $(".industrydescription").val(),
            AssignedFreelancerId: $("#drp-assigned-freelancers").val(),
        };
        var formData = new FormData();
        for (var i = 0; i < files.length; i++) {
            formData.append("httpPostedFileBase", files[i]);
        }
        formData.append("SolutionData", JSON.stringify(SolutionData));
        $("#preloader").show();
        $.ajax({
            url: '/Solutions/AddorEditSolutionDetails',
            type: "POST",
            contentType: false,
            processData: false,
            data: formData,
            dataType: 'json',
            success: function (result) {
                $("#preloader").hide();
                alert(result.Message);
                ResetSolutionIndustryDetailForm();
                GetSolutionList();
            },
            error: function (err) {
                $("#preloader").hide();
                alert("Something Went Wrong!");
            }
        });
     }

    function ResetSolutionIndustryDetailForm() {
        $("#EditsolutionModal").modal('hide');
        $("#solution-img").remove();
        $("#SolutionTitle").val("");
        $("#Solution_SubTitle").val("");
        $("#SolutionDescription").val("");
        $("#SolutionImage").val("");
        $('#drp-services').val("").trigger('chosen:updated');
        $("#drp-industries").val("").trigger('chosen:updated');
       
            $("#SolutionDetailsId").val(0);
        $(".SolutionImage").attr('src', "");
            $("#solutionImagepreview").hide();
            $("#ImagePath").val("");
            $('.cls-industriesdiv').remove();
    }
</script>