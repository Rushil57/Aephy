@{
    ViewData["Title"] = "- Describe solution";
}
<main id="main" class="main">
    <div class="row">
        <!-- Recent Sales -->
        <div class="col-12">
            <div class="card recent-sales overflow-auto">

                <div class="card-body">
                    <h5 class="card-title">Solutions</h5>

                    <table class="table table-borderless datatable" id="solutionList">
                        <thead>
                            <tr>
                                <th style="width:10%">Id</th>
                                <th style="width:10%">Title</th>
                                @*  <th style="width:10%">Sub Title</th>*@
                                <th style="width:30%">Description</th>
                                <th style="width:20%">Image</th>
                                <th style="width:10%">Services</th>
                                <th style="width:10%">Industries</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div><!-- End Recent Sales -->
    </div>
</main>

<div class="modal" id="EditsolutionModal" tabindex="-1" aria-labelledby="editSolutionModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Edit Solution</h4>
                <a class="close" onclick="ResetSolutionIndustryDetailForm();"><i class="bi bi-x-circle"></i></a>
            </div>
            <div class="modal-body p-0">
                <div class="row">
                    <div class="col">
                        <div class="card">
                            <div class="card-body">

                                <form class="row g-3 mt-3 cls-Solution" name="addSolutiondescribeForm">
                                    <input type="hidden" id="SolutionDetailsId" value="0">
                                    <input type="hidden" id="SolutionId" value="0">
                                    <input type="hidden" id="ImagePath" value="">

                                    <div class="col-12" style="display:none;">
                                        <label for="SolutionTitle" class="form-label">Solution Title</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="SolutionTitle" name="SolutionTitle" readonly>
                                        </div>
                                    </div>
                                    <div class="col-12 cls-subtitle" style="display:none;">
                                        <label for="Solution_SubTitle" class="form-label">Solution SubTitle</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="Solution_SubTitle" name="Solution_SubTitle" readonly>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <label for="Services" class="form-label">Services</label>
                                        <div class="input-group" id="services">
                                            <select data-placeholder="Choose tags ..." id="drp-services" name="SolutionServices" class="form-control" disabled>
                                                <option value="">Choose Services</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-12" style="display:none;">
                                        <label for="SolutionDescription" class="form-label">Solution Description</label>
                                        <div class="input-group">
                                            <textarea class="form-control" id="SolutionDescription" name="SolutionDescription" style="height:100px;" readonly></textarea>
                                        </div>
                                    </div>
                                    <div class="col-12" id="img-id" style="display:none;">
                                        <label for="SolutionImage" class="form-label">Image</label>
                                        <div class="input-group">
                                            <input type="file" class="form-control" id="SolutionImage" name="SolutionImage" disabled />
                                        </div>
                                        <div id="solutionImagepreview"></div>
                                    </div>

                                    <div class="col-12">
                                        <label for="drp-assigned-freelancers" class="form-label">
                                            <a class="text-primary" onclick="OpenFreelancePopup();">Assigned Freelancer</a>
                                        </label>
                                        <div class="input-group">
                                            <table class="table" id="AssignFreeLancerTable">
                                                <thead style="border: 1px solid #e8e8e8;">
                                                    <tr>
                                                        <th>Id</th>
                                                        <th>First Name</th>
                                                        <th>Last Name</th>
                                                        <th>FreeLancer Lavel</th>
                                                        <th>IsProjectArchitect</th>
                                                        <th>Delete</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="AssignFreeLancerbody">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <div class="col-12" id="main-industry-div">
                                        <label for="Industries" class="form-label">Industries</label>
                                        <div class="input-group" id="industries">
                                            <select data-placeholder="Choose tags ..." name="Industries" multiple class="chosen-select" id="drp-industries">
                                            </select>
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <label for="IsActiveByAdmin" class="form-label">Is Active</label>
                                        <div class="input-group" id="IsActiveByAdmindiv">
                                            <input type="checkbox" id="IsActiveByAdmin" class="form-check-input" />
                                        </div>
                                    </div>

                                    <div class="text-center">
                                        <button type="submit" class="btn btn-brand">Submit</button>
                                        <button type="reset" class="btn btn-secondary" onclick="ResetSolutionIndustryDetailForm();">Close</button>
                                    </div>

                                    <hr />
                                    Project Architecture - Details

                                    <div class="col-12">
                                        <label for="SolutionDescription" class="form-label">Project Outline</label>
                                        <div class="input-group">
                                            <textarea class="form-control" id="projectOutline" name="projectOutline" style="height:100px;" readonly></textarea>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <label for="SolutionDescription" class="form-label">Milestone(s)</label>
                                        <div class="input-group">
                                            <table class="table" id="MileStoneTable">
                                                <thead style="border: 1px solid #e8e8e8;">
                                                    <tr>
                                                        <th>Id</th>
                                                        <th>Description</th>
                                                        <th>Title</th>
                                                        @*<th>DueDate</th>*@
                                                    </tr>
                                                </thead>
                                                <tbody class="MileStonebody">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="text-center">
                                        <button type="button" onclick="ActionByAdminOnSolution('1')" class="btn btn-brand">Approve</button>
                                        <button type="button" onclick="ActionByAdminOnSolution('2')" class="btn btn-secondary">Reject</button>
                                    </div>
                                </form><!-- Vertical Form -->


                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="addFreeLanceModal" tabindex="-1" aria-labelledby="guidelineModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Add New User</h4>
                <a class="close" onclick="ResetFreeLanceForm();"><i class="bi bi-x-circle"></i></a>
            </div>
            <div class="modal-body p-0">
                <div class="row">
                    <div class="col">
                        <div class="card">
                            <div class="card-body">
                                <!-- Vertical Form -->
                                <form class="row g-3 mt-3" name="addInviteForm">

                                    <div class="col-12">
                                        <label for="FreeLancerLavel" class="form-label">Select Lavel</label>
                                        <div class="input-group">
                                            <select class="form-select" aria-label="Default select example" name="level" id="FreeLancerLavel">
                                                <option value="">Select Level</option>
                                                <option value="Experts">Experts</option>
                                                <option value="Associate">Associate</option>
                                                <option value="Project Manager">Project Manager</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <label for="FreeLancers" class="form-label">Freelancers</label>
                                        <div class="input-group">
                                            <table class="table" id="FreeLancerTable">
                                                <thead style="border: 1px solid #e8e8e8;">
                                                    <tr>
                                                        <th></th>
                                                        <th>First Name</th>
                                                        <th>Last Name</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="FreeLancerbody">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <div class="text-center">
                                        <button type="button" id="AddFreeLancer" class="btn btn-brand">Add FreeLancer</button>
                                        <button type="reset" class="btn btn-secondary" onclick="ResetFreeLanceForm();">Reset</button>
                                    </div>
                                </form><!-- Vertical Form -->

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>

    let finalIdsData = [];

    $(function () {
        $("form[name='addSolutiondescribeForm']").validate({
            rules: {
                SolutionTitle: { required: true },

            },
            messages: {
                SolutionTitle: { required: "please select solution" },

            },
            submitHandler: function (form) {
                SaveDescribeSolutionData()
            }
        });
        GetSolutionList()
        $(".cls-subtitle").css("display", "none")

    });

    function GetSolutionList() {
        $("#preloader").show();
        $.ajax({
            type: "Get",
            url: "@Url.Action("GetSolutionsIndustryDetailList", "Solutions")",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (result) {
                $("#preloader").hide();
                $('#solutionList').DataTable({
                    destroy: true,
                    data: result.Result,
                    "columns": [
                        {
                            "data": "Id",
                            "render": function (data, type, row) {
                                return '<a class="cls-service" onclick=GetSolutionDetailsDataById(' + data + ')>' + data + '</a>';
                            }
                        },
                        { "data": "Title" },
                        //{ "data": "SubTitle" },
                        {
                            "data": "Description",
                            "render": function (data, type, row) {
                                if (data != null) {
                                    var description = data.length > 35 ? data.substring(0, 35) + "..." : data;
                                    return "<span title='" + data + "'>" + description + "</span>";
                                }
                                else {
                                    return "<span></span>";
                                }

                            }
                        },
                        {
                            "data": "ImageUrlWithSas",
                            "render": function (data, type, row) {
                                if (data != null) {
                                    return '<img src="' + data + '" alt="Image" height="70" width="150" />';
                                }
                                else {
                                    return "<span></span>";
                                }

                            }
                        },
                        { "data": "Services" },
                        { "data": "Industries" }

                    ]
                });


            },
            error: function (result) {
                //alert("failure");
                showToaster("error", "Error !", "Failure");
            }
        });
    }


    function GetSolutionDetailsDataById(Id) {
        var ServiceData = {
            Id: Id,
        };
         $("#preloader").show();
        $("#drp-assigned-freelancers").empty();
        $("#MileStoneTable tbody").empty();
        GetFreelancerList();
        $.ajax({
            type: "POST",
            url: "@Url.Action("GetSolutionDetailsById", "Solutions")",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            data: JSON.stringify(ServiceData),
            success: function (result) {

                $("#EditsolutionModal").modal('show')
                $("#SolutionDetailsId").val(result.Result.SolutionIndustryDetails.Id)
                $("#SolutionTitle").val(result.Result.Solution.Title)
                $("#SolutionId").val(result.Result.Solution.Id)
                $("#Solution_SubTitle").val(result.Result.Solution.SubTitle)
                $("#SolutionDescription").val(result.Result.Solution.Description)
                $("#drp-assigned-freelancers").val(result.Result.SolutionIndustryDetails.AssignedFreelancerId).trigger('chosen:updated');
                $("#drp-services").val(result.Result.Services.ServicesId)
                $('#drp-industries').val(result.Result.Industryname.Id).trigger('chosen:updated');
                $('#drp-industries option').attr('disabled', true).trigger('chosen:updated');
                $("#solutionImagepreview").find("span").first().remove();
                $("#IsActiveByAdmin").prop('checked', result.Result.SolutionIndustryDetails.IsActiveByAdmin == 1 ? true : false);
                //
                $("#projectOutline").val(result.Result.SolutionIndustryDetails.ProjectOutline);
                //result.Result.MilestoneDetails
                var htm = '';
                for (index = 0; index < result.Result.MilestoneDetails.length; index++) {
                    subObj = result.Result.MilestoneDetails[index];

                    htm += '<tr>';
                    //htm += '<td class="" >' + subObj.Id + '</td>';
                    htm += '<td onclick=EditMiletoneData(' + subObj.Id + ')>' + subObj.Id + '</td>';
                    htm += '<td>' + subObj.Description + '</td>';
                    htm += '<td>' + subObj.Title + '</td>';
                    //htm += '<td>' + moment(subObj.DueDate).format('YYYY-MM-DD') + '</td>';
                    htm += '</tr>';
                }
                $("#MileStoneTable").find("tr:gt(0)").remove();
                $("#MileStoneTable tbody").append(htm);
                //
                $('#solutionImagepreview').show();
                var span = document.createElement('span');
                span.innerHTML =
                    ['<img class="SolutionImage" src="', result.Result.Solution.ImageUrlWithSas, '" style="height:200px;width:200px;"/>']
                        .join('');
                document.getElementById('solutionImagepreview').insertBefore(span, null);

                BindIndustriesControles(result.Result.Industryname, result.Result.SolutionIndustryDetails);



                DestroyDatatable("#AssignFreeLancerTable");
                finalIdsData = [];
                if (result.Result.FreeLancerPoolIds.length > 0) {
                    result.Result.FreeLancerPoolIds.forEach(function (key) {
                        finalIdsData.push(key);
                    });

                    RefreshDataTable();
                }
                 $("#preloader").hide();
            },
            error: function (result) {
                //alert("Error occured..");
                showToaster("error", "Error !", "Something went wrong !!");
            }
        });
    }

    function GetFreelancerList() {
        $.ajax({
            type: "Get",
            url: "@Url.Action("GetFreelancers", "Solutions")",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (result) {
                $.each(result.Result, function (data, value) {
                    $("#drp-assigned-freelancers").append($("<option     />").val(value.Id).text(value.FirstName + " " + value.LastName));
                });
                $('#drp-assigned-freelancers').trigger('chosen:updated');
            },
            error: function (err) {
                $("#preloader").hide();
                //alert("Something Went Wrong!");
                showToaster("error", "Error !", "Something went wrong !!");
            }
        });
    }

    function GetAssignedFreelancerById() {
        $.ajax({
            type: "Get",
            url: "@Url.Action("GetFreelancers", "Solutions")",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (result) {
                $.each(result.Result, function (data, value) {
                    $("#drp-assigned-freelancers").append($("<option     />").val(value.Id).text(value.FirstName + " " + value.LastName));
                });
                $('#drp-assigned-freelancers').trigger('chosen:updated');
            },
            error: function (err) {
                $("#preloader").hide();
                //alert("Something Went Wrong!");
                showToaster("error", "Error !", "Something went wrong !!");
            }
        });
    }

    function BindIndustriesControles(value, IndustryValue) {
        if (IndustryValue.Description == null) {
            IndustryValue.Description = "";
        }
        var addcontrols = "<div class='cls-industriesdiv'>" +
            "<div class='col-12'>" +
            "<label class='form-label'>Description (" + value.IndustryName + ") </label>" +
            "<div class='input-group'>" +
            //"<textarea type='text' class='form-control industrydescription' id=\"Description_" + value.IndustryName + "\" value=" + IndustryValue.Description + "></textarea>" +
            '<input type="text" class="form-control industrydescription"  value="' + IndustryValue.Description + '">' +
            "</div>" +
            "</div>" +
            "<div class='col-12'>" +
            "<label class='form-label'>Image (" + value.IndustryName + ")</label>" +
            "<div class='input-group'>" +
            "<input type='file' class='form-control industryImage' id=\"Image_" + value.IndustryName + "\" onchange='ChangeUploadImage(this)'>" +
            "</div>" +
            '<div id=solutionDetailsImagepreview_' + value.IndustryName + '>' +
            "</div>" +
            "</div>"
        $(addcontrols).insertAfter("#main-industry-div");

        if (IndustryValue.ImageUrlWithSas != null) {
            $("#solutionDetailsImagepreview_" + value.IndustryName).find("span").first().remove();
            $('#solutionDetailsImagepreview_' + value.IndustryName).show();
            var span = document.createElement('span');
            span.innerHTML =
                ['<img class="SolutionImage" src="', IndustryValue.ImageUrlWithSas, '" style="height:200px;width:200px;"/>']
                    .join('');
            document.getElementById('solutionDetailsImagepreview_' + value.IndustryName).insertBefore(span, null);
        }
    }

    function ChangeUploadImage(value) {
        var name = value.id.split("_")[1]
        if (value.files && value.files[0]) {
            var reader = new FileReader();
            reader.onload = (function (e) {
                $("#solutionDetailsImagepreview_" + name).find("span").first().remove();
                $('#solutionDetailsImagepreview_' + name).show();
                var span = document.createElement('span');
                span.innerHTML =
                    ['<img class="SolutionImage" src="', e.target.result, '" title="', escape(e.name), '" style="height:200px;width:200px;"/>']
                        .join('');
                document.getElementById('solutionDetailsImagepreview_' + name).insertBefore(span, null);
            });

            reader.readAsDataURL(value.files[0]);
        }
    }

    function SaveDescribeSolutionData() {

        var architectData = [];
        //$(':checkbox:checked').each(function (i) {
        //    architectData.push($(this).val());
        //});

        $("#chkArchitect:checked").each(function (i) {
            architectData.push($(this).val());
        });

        console.log(architectData);

        var freelancerId = $("#drp-assigned-freelancers").val();
        var fileUpload = $(".industryImage").get(0);
        var files = fileUpload.files;
        var SolutionData = {
            Id: $("#SolutionDetailsId").val(),
            Description: $(".industrydescription").val(),
            AssignedFreelancerIds: finalIdsData,
            IsArchitectIds: architectData,
            ActiveByAdmin: $("#IsActiveByAdmin").prop('checked') ? 1 : 2,
            SolutionId: $("#SolutionId").val()
        };
        var formData = new FormData();
        for (var i = 0; i < files.length; i++) {
            formData.append("httpPostedFileBase", files[i]);
        }
        formData.append("SolutionData", JSON.stringify(SolutionData));
        $("#preloader").show();
        $.ajax({
            url: '/Solutions/AddorEditSolutionDetails',
            type: "POST",
            contentType: false,
            processData: false,
            data: formData,
            dataType: 'json',
            success: function (result) {
                $("#preloader").hide();
                //alert(result.Message);
                showToaster("success", "Success", result.Message);
                ResetSolutionIndustryDetailForm();
                GetSolutionList();
            },
            error: function (err) {
                $("#preloader").hide();
                //alert("Something Went Wrong!");
                showToaster("error", "Error !", "Something went wrong !!");
            }
        });
    }

    function ResetSolutionIndustryDetailForm() {
        $("#EditsolutionModal").modal('hide');
        $("#solution-img").remove();
        $("#SolutionTitle").val("");
        $("#Solution_SubTitle").val("");
        $("#SolutionDescription").val("");
        $("#SolutionImage").val("");
        $('#drp-services').val("").trigger('chosen:updated');
        $("#drp-industries").val("").trigger('chosen:updated');

        $("#SolutionDetailsId").val(0);
        $("#SolutionId").val(0);
        $(".SolutionImage").attr('src', "");
        $("#solutionImagepreview").hide();
        $("#ImagePath").val("");
        $('.cls-industriesdiv').remove();
    }

    function ActionByAdminOnSolution(actionVal) {
        try {
            $("#preloader").show();
            $.ajax({
                url: '/Solutions/ActionByAdminOnSolution?solutionIndustryDetailsId=' + $("#SolutionDetailsId").val() + '&actionType=' + actionVal,
                type: "POST",
                data: {},
                dataType: 'json',
                success: function (result) {
                    $("#preloader").hide();
                    //alert(result.Message);
                    showToaster("success", "Success", result.Message);
                    ResetSolutionIndustryDetailForm();
                    GetSolutionList();
                },
                error: function (err) {
                    $("#preloader").hide();
                    //alert("Something Went Wrong!");
                    showToaster("error", "Error !", "Something went wrong !!");
                }
            });
        }
        catch (err) {
            //alert(err);
            showToaster("error", "Error !", err);
        }
    }

    function OpenFreelancePopup() {
        $("#EditsolutionModal").modal('hide');
        $("#addFreeLanceModal").modal('show');

        DestroyDatatable("#FreeLancerTable");
        $("#FreeLancerLavel").val('');
    }

    function ResetFreeLanceForm() {
        $("#addFreeLanceModal").modal('hide');
        $("#EditsolutionModal").modal('show');
    }

    $("#FreeLancerLavel").change(function () {

        $.ajax({
            type: "GET",
            url: "@Url.Action("GetFreeLancerByType", "Solutions")",
            data: { freeLancerLavel: this.value },
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (result) {

                $('#FreeLancerTable').DataTable({
                    destroy: true,
                    data: result.Result,
                    paging: false,
                    lengthChange: false,
                    searching: false,
                    ordering: false,
                    info: false,
                    autoWidth: false,
                    responsive: false,
                    "columns": [
                        {
                            "data": "Id",
                            "render": function (data, type, row) {
                                return "<input type=\"checkBox\" id=\"" + row.Id + "\" value=\"" + row.Id + "\"/>";
                            }
                        },
                        { "data": "FirstName" },
                        { "data": "LastName" },
                    ]
                });
            },
            error: function (result) {
                showToaster("error", "Error !", "Something went wrong !!");
            }

        });

    });


    $("#AddFreeLancer").click(function () {

        $(':checkbox:checked').each(function (i) {
            finalIdsData.push($(this).val());
        });

        if ($("#FreeLancerLavel").val() != '' && finalIdsData.length != 0) {
            RefreshDataTable();
        }
        else
        {
            showToaster("error", "Validation Error !", "Please select Lavel or Freelancer");
        }
    });

    function RemoveFreeLancer(id) {
        const index = finalIdsData.indexOf(id);
        if (index > -1) {
            finalIdsData.splice(index, 1);
        }

        RefreshDataTable();
        //showToaster("success", "Success", "Recored Deleted.");
    }

    function RefreshDataTable() {

        var userIdsModel = {
            Ids: finalIdsData,
        };

        $.ajax({
            type: "POST",
            url: "@Url.Action("GetUsersByIds", "Solutions")",
            data: JSON.stringify(userIdsModel),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (result) {

                $("#addFreeLanceModal").modal('hide');
                $("#EditsolutionModal").modal('show');

                $('#AssignFreeLancerTable').DataTable({
                    destroy: true,
                    data: result.Result,
                    paging: false,
                    lengthChange: false,
                    searching: false,
                    ordering: false,
                    info: false,
                    autoWidth: false,
                    responsive: false,
                    "columns": [
                        { "data": "Id", "visible": false },
                        { "data": "FirstName" },
                        { "data": "LastName" },
                        { "data": "Lavel" },
                        {
                            "data": "Id",
                            "render": function (data, type, row) {
                                if (row.Lavel == "Project Manager") {
                                    return "<input type=\"checkBox\" id=\"chkArchitect\" value=\"" + row.Id + "\" />";
                                }
                                else {
                                    return "";
                                }
                            }
                        },
                        {
                            "data": "Id",
                            "render": function (data, type, row) {
                                return "<a class=\"text-danger\" onclick=\"RemoveFreeLancer('" + row.Id + "');\">Delete</a>";
                            }
                        },
                    ]
                });
            },
            error: function (result) {
                showToaster("error", "Error !", "Something went wrong !!");
            }
        });
    }

    function DestroyDatatable(tableId) {
        var table = $(tableId).DataTable({
            destroy: true,
            paging: false,
            lengthChange: false,
            searching: false,
            ordering: false,
            info: false,
            autoWidth: false,
            responsive: false,
        });
        table.clear().draw();
    }

</script>