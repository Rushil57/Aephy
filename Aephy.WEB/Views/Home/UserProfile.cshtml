@{
    ViewData["Title"] = "User profile";
    ViewData["Role"] = Context.Session.GetString("LoggedUserRole");
    ViewData["Fullname"] = Context.Session.GetString("FullName");
    ViewData["ProfileImage"] = Context.Session.GetString("UserProfileImage");
}

<main id="main" class="main">

    <div class="pagetitle">
        <h1>Profile</h1>
    </div><!-- End Page Title -->

    <section class="section profile">
        <div class="row">
            <div class="col-xl-4">

                <div class="card">
                    <div class="card-body profile-card pt-4 d-flex flex-column align-items-center">
                        @{
                            if (ViewData["ProfileImage"] != "")
                        {
                                <img src="@ViewData["ProfileImage"]" alt="Profile" class="rounded-circle">
                        }else{
                            <div id="name-initial" class="profile-pic">@Context.Session.GetString("ShortName")</div>
                        }
                        }
                        
                        
                        <h2 id="fullName"></h2>
                        <h3 id="userRole"></h3>
                        <div class="social-links mt-2">
                            <a href="#" class="twitter"><i class="bi bi-twitter"></i></a>
                            <a href="#" class="facebook"><i class="bi bi-facebook"></i></a>
                            <a href="#" class="instagram"><i class="bi bi-instagram"></i></a>
                            <a href="#" class="linkedin"><i class="bi bi-linkedin"></i></a>
                        </div>
                    </div>
                </div>

            </div>

            <div class="col-xl-8">

                <div class="card">
                    <div class="card-body pt-3">
                        <!-- Bordered Tabs -->
                        <ul class="nav nav-tabs nav-tabs-bordered">

                            <li class="nav-item">
                                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#profile-overview" onclick="GetUserData()">Overview</button>
                            </li>

                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#profile-edit" onclick="GetUserData()">Edit Profile</button>
                            </li>

                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#profile-change-password">Change Password</button>
                            </li>

                        </ul>
                        <div class="tab-content pt-2">

                            <div class="tab-pane fade show active profile-overview" id="profile-overview">

                                <h5 class="card-title">Profile Details</h5>
                                <div class="row">
                                    <div class="col-lg-3 col-md-4 label ">First Name</div>
                                    <div class="col-lg-9 col-md-8">
                                        <input name="fullName" type="text" class="form-control firstName" readonly>
                                    </div>

                                </div>

                                <div class="row">
                                    <div class="col-lg-3 col-md-4 label">Last Name</div>
                                    <div class="col-lg-9 col-md-8">
                                        <input name="fullName" type="text" class="form-control lastName" readonly>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-lg-3 col-md-4 label">Role</div>
                                    <div class="col-md-8 col-lg-9">
                                        <input name="roles" type="text" class="form-control role" readonly>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-lg-3 col-md-4 label">Email</div>
                                    <div class="col-md-8 col-lg-9">
                                        <input name="emailaddress" type="email" class="form-control emailId" readonly>
                                    </div>
                                </div>

                                <div class="ClientFields" style="display:none;">
                                    <div class="row">
                                        <div class="col-lg-3 col-md-4 label">Description</div>
                                        <div class="col-md-8 col-lg-9">
                                            <textarea name="Description" type="text" class="form-control description" rows="4" cols="50" readonly></textarea>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-lg-3 col-md-4 label">Address</div>
                                        <div class="col-md-8 col-lg-9">
                                            <textarea name="Address" type="text" class="form-control cls-client-address" rows="4" cols="50" readonly></textarea>
                                        </div>
                                    </div>
                                </div>

                                <div class="FreelancerFields" style="display:none;">
                                    <input type="hidden" value="" id="CVPath-id" />
                                    <div class="row">
                                        <div class="col-lg-3 col-md-4 label">Hourly Rate Per Day ($)</div>
                                        <div class="col-md-8 col-lg-9">
                                            <input name="HourlyRate" type="text" class="form-control hourlyRate" readonly>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-lg-3 col-md-4 label">Education</div>
                                        <div class="col-md-8 col-lg-9">
                                            <input name="Education" type="text" class="form-control education" readonly />
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-lg-3 col-md-4 label">Proffessional Experience</div>
                                        <div class="col-md-8 col-lg-9">
                                            <input name="ProffessionalExperience" type="text" class="form-control proffessionalExperience" readonly />
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-lg-3 col-md-4 label">Address</div>
                                        <div class="col-md-8 col-lg-9">
                                            <input name="Address" type="text" class="form-control cls-freelancer-address" readonly />
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-lg-3 col-md-4 label">Freelancer Level</div>
                                        <div class="col-md-8 col-lg-9">
                                            <input name="freelancerLevel" type="text" class="form-control drp-freelancer-level" readonly />
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-lg-3 col-md-4 label">Resume</div>
                                        <div class="col-md-8 col-lg-9">
                                            <a onclick="DownloadCv()" class="cls-resume-dwld" style="cursor:pointer">Download Resume</a>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <div class="tab-pane fade profile-edit pt-3" id="profile-edit">
                                <form name="UpdateForm">
                                    <div class="row mb-3">
                                        <label for="profileImage" class="col-md-4 col-lg-3 col-form-label">Profile Image</label>
                                        <div class="col-md-8 col-lg-9">
                                            <img src="" alt="Profile" id="profile-image">
                                            <div class="profile-pic" style="border-radius:0%;" id="profile-intial">@Context.Session.GetString("ShortName")</div>
                                            <div class="pt-2">
                                                <input type="file" id="Freelancer-profile" class="form-control" onchange="ShowUserImage(this)">
                                                @*<a href="#" class="btn btn-primary btn-sm" title="Upload new profile image"><i class="bi bi-upload"></i></a>*@
                                                @*<a href="#" class="btn btn-danger btn-sm" title="Remove my profile image"><i class="bi bi-trash"></i></a>*@
                                            </div>
                                        </div>
                                    </div>

                                    <input type="hidden" class="UserId" value="">
                                    <div class="row mb-3">
                                        <label for="firstName" class="col-md-4 col-lg-3 col-form-label">First Name</label>
                                        <div class="col-md-8 col-lg-9">
                                            <input name="firstName" type="text" class="form-control firstName" id="firstname">
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <label for="lastName" class="col-md-4 col-lg-3 col-form-label">Last Name</label>
                                        <div class="col-md-8 col-lg-9">
                                            <input name="lastName" type="text" class="form-control lastName" id="lastName">
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <label for="role" class="col-md-4 col-lg-3 col-form-label">Role</label>
                                        <div class="col-md-8 col-lg-9">
                                            <select class="form-select role" aria-label="Default select example" name="role" id="userType" disabled="true">
                                                <option value="Client">Client</option>
                                                <option value="Freelancer">Freelancer</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <label for="Email" class="col-md-4 col-lg-3 col-form-label">Email</label>
                                        <div class="col-md-8 col-lg-9">
                                            <input name="email" type="email" class="form-control emailId" id="emailId" readonly>
                                        </div>
                                    </div>

                                    <div class="ClientFields" style="display:none;">
                                        <div class="row mb-3">
                                            <label for="Description" class="col-md-4 col-lg-3 col-form-label">Description</label>
                                            <div class="col-md-8 col-lg-9">
                                                <textarea name="Description" type="text" class="form-control description" id="Description" rows="4" cols="50"></textarea>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <label for="Address" class="col-md-4 col-lg-3 col-form-label">Address</label>
                                            <div class="col-md-8 col-lg-9">
                                                <textarea name="Address" type="text" class="form-control cls-client-address" id="Client-Address" rows="4" cols="50"></textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="FreelancerFields" style="display:none;">
                                        <div class="row mb-3">
                                            <label for="HourlyRate" class="col-md-4 col-lg-3 col-form-label">Hourly Rate Per Day ($)</label>
                                            <div class="col-md-8 col-lg-9">
                                                <input name="HourlyRate" type="number" class="form-control hourlyRate" id="HourlyRate" />
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <label for="Education" class="col-md-4 col-lg-3 col-form-label">Education</label>
                                            <div class="col-md-8 col-lg-9">
                                                <input name="Education" type="text" class="form-control education" id="Education" />
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <label for="ProffessionalExperience" class="col-md-4 col-lg-3 col-form-label">Proffessional Experience</label>
                                            <div class="col-md-8 col-lg-9">
                                                <input name="ProffessionalExperience" type="text" class="form-control proffessionalExperience" id="ProffessionalExperience" />
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <label for="Address" class="col-md-4 col-lg-3 col-form-label">Address</label>
                                            <div class="col-md-8 col-lg-9">
                                                <textarea name="Address" type="text" class="form-control cls-freelancer-address" id="Freelancer-Address" rows="4" cols="50"></textarea>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <label for="Level" class="col-md-4 col-lg-3 col-form-label">Freelancer Level</label>
                                            <div class="col-md-8 col-lg-9">
                                                <select class="form-select drp-freelancer-level" aria-label="Default select example" name="level" id="level" disabled="true">
                                                    <option value="">Select Level</option>
                                                    <option value="Expert">Expert</option>
                                                    <option value="Associate">Associate</option>
                                                    <option value="Project Manager">Project Manager</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <label for="CVPath" class="col-md-4 col-lg-3 col-form-label">Upload CV</label>
                                            <div class="col-md-8 col-lg-9">
                                                <input class="form-control" type="file" id="CVPath" name="CVPath" accept=".pdf,.docx" style="max-height:37px;">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-center">
                                        <button type="submit" class="btn btn-primary">Save Changes</button>
                                    </div>
                                </form><!-- End Profile Edit Form -->
                            </div>

                            <div class="tab-pane fade pt-3" id="profile-change-password">
                                <!-- Change Password Form -->
                                <form name="UpdatepasswordForm">
                                    <div class="row mb-3">
                                        <label for="currentPassword" class="col-md-4 col-lg-3 col-form-label">Current Password</label>
                                        <div class="col-md-8 col-lg-9">
                                            <input name="password" type="password" class="form-control" id="currentPassword">
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <label for="newPassword" class="col-md-4 col-lg-3 col-form-label">New Password</label>
                                        <div class="col-md-8 col-lg-9">
                                            <input name="newpassword" type="password" class="form-control" id="newPassword">
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <label for="renewPassword" class="col-md-4 col-lg-3 col-form-label">Re-enter New Password</label>
                                        <div class="col-md-8 col-lg-9">
                                            <input name="renewpassword" type="password" class="form-control" id="renewPassword">
                                        </div>
                                    </div>

                                    <div class="text-center">
                                        <button type="submit" class="btn btn-primary">Change Password</button>
                                    </div>
                                </form><!-- End Change Password Form -->

                            </div>

                        </div>

                    </div>
                </div>
                <div id="preloader" style="display:none;"></div>
            </div>
        </div>
    </section>

</main><!-- End #main -->

<script type="text/javascript">
    $(function () {
        $("form[name='UpdateForm']").validate({
            rules: {
                firstName: { required: true },
                lastName: { required: true },
                email: {
                    required: true,
                    email: true
                },
                role: { required: true }
            },
            messages: {
                firstName: { required: "Please enter a firstname", },
                lastName: { required: "Please enter a lastname", },
                email: {
                    required: "Please enter email address",
                    email: "Please enter a valid email address"
                },
                role: { required: "Select valid role" },
            },
            submitHandler: function (form) {
                validateManually();
            }
        });

        $("form[name='UpdatepasswordForm']").validate({
            rules: {
                password: { required: true },
                newpassword: { required: true },
                renewpassword: {
                    required: true,
                    equalTo: "#newPassword"
                },
            },
            messages: {
                password: { required: "Please enter a password", },
                newpassword: { required: "Please enter a new password", },
                renewpassword: {
                    required: "Please enter confirm password",
                    equalTo: "password and new password should be same"
                },
            },
            submitHandler: function (form) {
                ChangePassword()
            }
        });
        GetUserData()
    });

    function GetUserData() {
         $('#preloader').show();
        $.ajax({
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            url: "@Url.Action("GetUserData", "Home")",
            success: function (result) {
                if (result != null) {
                    var data = result.Result;
                    CheckUserBasedonUserTye(data.Role)
                    $(".UserId").val(data.UserId)
                    $(".firstName").val(data.FirstName)
                    $(".lastName").val(data.LastName)
                    $(".role").val(data.Role)
                    $(".emailId").val(data.Email)
                    var Fullname = data.FirstName + " " + data.LastName
                    $("#fullName").text(Fullname)
                    $("#userRole").text(data.Role)
                    $(".hourlyRate").val(data.HourlyRate)
                    $(".education").val(data.Education)
                    $(".proffessionalExperience").val(data.ProffessionalExperience)
                    $(".cls-freelancer-address").val(data.FreelancerAddress)
                    $(".cls-client-address").val(data.ClientAddress)
                    $(".description").val(data.Description)
                    $(".drp-freelancer-level").val(data.FreelancerLevel)
                    $("#CVPath-id").val(data.CVPath)
                    if(data.CVPath != null){
                        addNameToFile(data.CVPath.split("/")[4])
                    }
                    if (data.ImageUrlWithSas != null){
                        $("#profile-intial").css("display","none")
                        $("#profile-image").attr("src", data.ImageUrlWithSas);
                        $("#Freelancer-profile").val("");

                    }else{
                        $("#Freelancer-profile").val("");
                        $("#profile-image").css("display", "none")
                         $("#profile-intial").css("display","flex")
                    }
                }
                 $('#preloader').hide();

            },
            error: function (result) {
                $('#preloader').hide();
                showToaster("error", "Error !", "Something went wrong !!");
            }
        });
    }

     function addNameToFile(url) {
        getImgURL(url, (imgBlob) => {
            let file = new File([imgBlob], url, { type: "pdf/application", lastModified: new Date().getTime() }, 'utf-8');
            let container = new DataTransfer();
            container.items.add(file);
            document.querySelector('#CVPath').files = container.files;
        })
    }

    function getImgURL(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.onload = function () {
            callback(xhr.response);
        };
        xhr.open('GET', url);
        xhr.responseType = 'blob';
        xhr.send();
    }


    function validateManually() {
        var hourlyRate = $("#HourlyRate").val();
        var level = $("#level").val();
        if (hourlyRate != null && level != null) {
            if (level == "Expert") {
                hourlyRate < 40 ? UpdateUserData() : alert('Hourly rate for ' + level + ' cannot be greater than $' + 40 + '.');
            } else if (level == "Associate" && hourlyRate < 20) {
                hourlyRate < 20 ? UpdateUserData() : alert('Hourly rate for ' + level + ' cannot be greater than $' + 20 + '.');
            } else if (level == "Project Manager/Project Architecture" && hourlyRate < 80) {
                hourlyRate < 80 ? UpdateUserData() : alert('Hourly rate for ' + level + ' cannot be greater than $' + 80 + '.');
            } else if (level == "Project Leader") {
                UpdateUserData();
            } else {
                //alert('invalid insertion..')
                showToaster("error", "Error !", "invalid insertion..");
            }
        }
    }

    function UpdateUserData() {
        var filename = $("#CVPath").val();
        if (filename != "") {
            var validFileExtentions = /(\.pdf|\.docx)$/i;
            if (!(validFileExtentions.exec(filename))) {
                showToaster("error", "Error !", "You can upload only PDF or Document file..");
                return
            }
        }

        var fileUpload = $("#CVPath").get(0);
        var files = fileUpload.files;

        var profile = $("#Freelancer-profile").get(0);
        var profileFiles = profile.files;

        var FreelancerDetail = {
            HourlyRate: $("#HourlyRate").val(),
            Education: $("#Education").val(),
            ProffessionalExperience: $("#ProffessionalExperience").val(),
            FreelancerAddress: $("#Freelancer-Address").val(),
        }

        var ClientDetail = {
            Description: $("#Description").val(),
            ClientAddress: $("#Client-Address").val(),
        }

        var Userdata = {
            Id: $(".UserId").val(),
            FirstName: $("#firstname").val(),
            LastName: $("#lastName").val(),
            UserType: $("#userType").val(),
            Email: $("#emailId").val(),
            freelancerDetail: FreelancerDetail,
            clientDetail: ClientDetail
        }

        var formData = new FormData();
        for (var i = 0; i < files.length; i++) {
            formData.append("httpPostedFileBase", files[i]);
        }
        for (var i = 0; i < profileFiles.length; i++) {
            formData.append("httpPostedFileBaseProfile", profileFiles[i]);
        }
        formData.append("Userdata", JSON.stringify(Userdata));
          $('#preloader').show();
        $.ajax({
            type: "POST",
            url: "@Url.Action("EditUserData", "Home")",
            contentType: false,
            processData: false,
            data: formData,
            success: function (result) {
                var test = result.split(",")[1].split(":")[1]
                showToaster("success", "Success", test.replace(/\"/g, ""));
                  $('#preloader').hide();
            },
            error: function (result) {
                $('#preloader').hide();
                showToaster("error", "Error !", "Failure");

            }
        });
    }


    function ChangePassword() {
        var passwordData = {
            Id: $(".UserId").val(),
            CurrentPassword: $("#currentPassword").val(),
            NewPassword: $("#newPassword").val(),
        }
        $('#preloader').show();
        $.ajax({
            type: "POST",
            url: "@Url.Action("UpdateUserPassword", "Home")",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            data: JSON.stringify(passwordData),
            success: function (result) {
                showToaster("success", "Success", result.Message);
                ResetUpdateForm()
                $('#preloader').show();
            },
            error: function (result) {
                showToaster("error", "Error !", "Something went wrong !!");
            }
        });
    }

    function ResetUpdateForm() {
        $("#currentPassword").val("");
        $("#newPassword").val("");
        $("#renewPassword").val("")
    }

    function CheckUserBasedonUserTye(role) {
        if (role == "Freelancer") {
            $(".FreelancerFields").show();
            $(".ClientFields").hide()
        }
        else {
            $(".FreelancerFields").hide();
            $(".ClientFields").show();
        }
    }

    function DownloadCv() {
        var Cvname = $("#CVPath-id").val()
        if (Cvname != "") {
            window.location = "@Url.Action("DownloadApplicantCV", "Home")?Cvname=" + Cvname;
        }
    }

    function ShowUserImage(value) {
        $("#profile-intial").css("display", "none")
        $("#profile-image").css("display", "block")
        if (value.files && value.files[0]) {
            var reader = new FileReader();
            reader.onload = (function (e) {
                $("#profile-image").attr("src", e.target.result);
            });

            reader.readAsDataURL(value.files[0]);
        }
    }
</script>